- id: vacuum_start_cleaning
  alias: Vacuum Start Cleaning
  description: Regular vacuum cleaning every two days
  trigger:
    - platform: time
      at: '15:00'
    - platform: state
      entity_id: group.family
      from: 'home'
      to: 'not_home'
      for: '00:10:00'
  condition:
    # There was no cleaning in past 36 hours
    - condition: template
      value_template: >
        {% set last_cleaning = as_timestamp(state_attr('vacuum.roborock', 'clean_start')) | int %}
        {% set current_time = as_timestamp(now()) | int %}
        {{ current_time - last_cleaning > (60 * 60 * 36) }}
  action:
    - service: notify.all
      data:
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        message: '–ü–æ—á–∏–Ω–∞—î–º–æ –ø–ª–∞–Ω–æ–≤–µ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –≤–¥–æ–º–∞.'
    - service: vacuum.set_fan_speed
      entity_id: vacuum.roborock
      data:
        fan_speed: Turbo
    - delay: '00:00:05'
    - service: vacuum.start
      entity_id: vacuum.roborock

- id: vacuum_finish_cleaning
  alias: Vacuum Stop Cleaning
  description: Send vacuum home when somebody comes home
  trigger:
    platform: state
    entity_id: group.family
    from: not_home
    to: home
  action:
    - service: vacuum.return_to_base
      entity_id: vacuum.roborock

- id: vacuum_ask_maintenance
  alias: Vacuum Maintenance
  description: Send vacuum near trash bin and ask for maintenance
  trigger:
    platform: state
    entity_id: vacuum.roborock
    to: 'docked'
  condition:
    # Every 10th cleaning
    - condition: template
      value_template: >
        {{ state_attr('vacuum.roborock', 'cleaning_count') % 10 == 0 }}
    # And there was at least one cleaning after previous maintenance
    - condition: template
      value_template: >
        {% set last_maintenance = as_timestamp(state_attr('automation.vacuum_maintenance', 'last_triggered')) | int %}
        {% set last_cleaning = as_timestamp(state_attr('vacuum.roborock', 'clean_start')) | int %}
        {{ last_cleaning > last_maintenance }}
  action:
    - service: notify.all
      data:
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        message: '–ß–∞—Å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –ø–∏–ª–æ—Å–æ—Å–∞. –í–∏–∫–∏–Ω—å—Ç–µ —Å–º—ñ—Ç—Ç—è, –Ω–∞–±–µ—Ä—ñ—Ç—å –≤–æ–¥–∏ —ñ –ø–æ—á–∏—Å—Ç—ñ—Ç—å –≥–∞–Ω—á—ñ—Ä–∫—É.'
    - service: vacuum.send_command
      entity_id: vacuum.roborock
      data:
        command: app_goto_target
        params: [24500, 24500] # Coordinates near the trash bin
