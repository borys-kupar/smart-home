- id: do_not_disturb
  alias: Do Not Disturb Flow
  description: Adjust devices to Do Not Disturb mode
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: input_boolean.do_not_disturb
  action:
    # Google Home
    - service: media_player.volume_set
      entity_id: media_player.google_home_mini
      data:
        volume_level: >
          {% if is_state('input_boolean.do_not_disturb', 'on') %}
            0.5
          {% else %}
            0.8
          {% endif %}
    # Purifier
    # Set Purifier speed only when it's running
    - service: fan.set_speed
      entity_id: fan.purifier
      data:
        speed: >
          {% if is_state('fan.purifier', 'on') %}
            {% if is_state('input_boolean.do_not_disturb', 'on') %}
              Silent
            {% else %}
              Auto
            {% endif %}
          {% endif %}
    # Humidifier
    - service: >
        {% if is_state('input_boolean.do_not_disturb', 'on') %}
          xiaomi_miio_airpurifier.fan_set_led_off
        {% else %}
          xiaomi_miio_airpurifier.fan_set_led_on
        {% endif %}
      entity_id: fan.humidifier

- id: do_not_disturb_while_sleeping_time
  alias: Do Not Disturb while Sleeping Time
  description: Switch Do Not Disturb along with Sleeping Time
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: binary_sensor.sleeping_time
  action:
    - service: input_boolean.turn_{{ states('binary_sensor.sleeping_time') }}
      entity_id: input_boolean.do_not_disturb
